<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>YouTube Radio</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    button {
      margin: 4px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

</head>

<body>

  <h2>ðŸ“» Web Radio</h2>

  <label>Radio Assets (.zip):</label>
  <input type="file" id="radioZip" accept=".zip">

  <input id="playlistUrl" placeholder="YouTube Playlist URL" size="60">
  <button onclick="initRadio()">Start Radio</button>

  <br><br>
  <button onclick="play()">Play</button>
  <button onclick="pause()">Pause</button>

  <div id="player"></div>

  <audio id="audio"></audio>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    function guessMimeType(path) {
      if (path.endsWith(".mp3")) return "audio/mpeg";
      if (path.endsWith(".ogg")) return "audio/ogg";
      if (path.endsWith(".wav")) return "audio/wav";
      return "application/octet-stream";
    }

    async function loadRadioZip(file) {
      blurbs = [];
      commercials = [];
      talks = [];

      const zip = await JSZip.loadAsync(file);

      for (const [path, entry] of Object.entries(zip.files)) {
        if (entry.dir) continue;

        const lower = path.toLowerCase();
        if (!lower.match(/\.(mp3|ogg|wav)$/)) continue;

        const buffer = await entry.async("arraybuffer");

        const blob = new Blob([buffer], {
          type: guessMimeType(lower)
        });

        const url = URL.createObjectURL(blob);
        console.log(lower);
        console.log(blob);
        if (lower.includes("/blurbs/")) blurbs.push(url);
        else if (lower.includes("/ads/")) commercials.push(url);
        else if (lower.includes("/talk/")) talks.push(url);
      }

      console.log("ZIP loaded:", {
        blurbs: blurbs.length,
        commercials: commercials.length,
        talks: talks.length
      });
    }
    const schedule = {
      "schedule": [
        {
          "type": "blurb",
          "min": 1,
          "max": 1
        },
        {
          "type": "music",
          "min": 1,
          "max": 1
        },
        {
          "type": "commercial",
          "min": 1,
          "max": 3
        },
        {
          "type": "talk",
          "min": 1,
          "max": 1
        },
        {
          "type": "music",
          "min": 1,
          "max": 1
        },
        {
          "type": "blurb",
          "min": 0,
          "max": 1
        },
        {
          "type": "music",
          "min": 0,
          "max": 1
        },
        {
          "type": "commercial",
          "min": 1,
          "max": 3
        },
        {
          "type": "blurb",
          "min": 1,
          "max": 1
        },
        {
          "type": "talk",
          "min": 1,
          "max": 1
        },
        {
          "type": "music",
          "min": 1,
          "max": 1
        },
        {
          "type": "commercial",
          "min": 1,
          "max": 3
        }
      ]
    }

    let playbackQueue = [];
    let videoIds = [];
    let player;
    let audio = document.getElementById("audio");

    let blurbs = [];
    let commercials = [];

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "360",
        width: "640",
        playerVars: { autoplay: 0, controls: 1 },
        events: {
          onStateChange: e => {
            if (e.data === YT.PlayerState.ENDED) playNext();
          }
        }
      });
    }
    async function initRadio() {
      const zipInput = document.getElementById("radioZip");

      if (!zipInput.files.length) {
        alert("Please upload a radio_assets.zip file");
        return;
      }

      await loadRadioZip(zipInput.files[0]);

      generateSchedule();
      await loadPlaylist();
      playNext();
    }


    function generateSchedule() {
      playbackQueue = [];

      for (const block of schedule.schedule) {
        const count = rand(block.min, block.max);
        for (let i = 0; i < count; i++) {
          playbackQueue.push(block.type);
        }
      }

      console.log("Schedule:", playbackQueue);
    }

    async function loadPlaylist() {
      const url = document.getElementById("playlistUrl").value;
      const list = new URL(url).searchParams.get("list");

      const res = await fetch(`https://corsproxy.io/?https://www.youtube.com/playlist?list=${list}`);
      const text = await res.text();

      videoIds = [...new Set(
        [...text.matchAll(/"videoId":"(.*?)"/g)].map(m => m[1])
      )];

      shuffle(videoIds);
    }

    function playNext() {
      if (playbackQueue.length === 0) {
        generateSchedule();
      }

      const type = playbackQueue.shift();

      if (type === "music") {
        const id = videoIds.shift();
        videoIds.push(id);
        player.loadVideoById(id);
      }

      if (type === "blurb") {
        playLocalRandom(blurbs);
      }

      if (type === "commercial") {
        playLocalRandom(commercials);
      }
      if (type === "talk") {
        playLocalRandom(talks);
      }
    }

    function playLocalRandom(list) {
      if (!list.length) {
        playNext();
        return;
      }

      const src = list[Math.floor(Math.random() * list.length)];
      audio.src = src;
      audio.onended = playNext;
      audio.play();
    }

    function play() {
      if (player?.getPlayerState() === YT.PlayerState.PAUSED) player.playVideo();
      audio.play();
    }

    function pause() {
      player.pauseVideo();
      audio.pause();
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function rand(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
  </script>

</body>

</html>